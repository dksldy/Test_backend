# 연말정산 공제 규칙 엔진 DB 설계 지침서

## 1. 문서 목적
본 문서는 연말정산 공제 계산 시스템의 **DB 설계 기준 문서(Source of Truth)** 이다.
본 지침서는 다음 목적을 가진다.

- ERD 설계 의도 명문화
- 계산 엔진 동작 방식 고정
- 관리자/개발자 간 해석 차이 제거
- 향후 확장 및 유지보수 기준 제공

본 문서를 기준으로 **테이블 구조, 계산 로직, 운영 원칙은 일관되게 유지**되어야 한다.

---

## 2. 설계 철학

### 2.1 핵심 원칙

1. **계산 알고리즘은 코드에 고정한다**
   - DB에는 계산식 자체를 저장하지 않는다.
   - 비율, 한도, 조건만 데이터로 관리한다.

2. **법 개정 대응은 DDL 없이 처리한다**
   - INSERT / UPDATE 만으로 정책 변경 가능해야 한다.

3. **모든 공제는 규칙 단위로 분해한다**

```
공제(What)
 └─ 규칙(Case)
     └─ 조건(IF)
     └─ 파라미터(Number)
```

4. **삭제보다 비활성화(ACTIVE_YN)를 우선한다**

---

## 3. 도메인 구성 개요

| 도메인 | 설명 |
|---|---|
| 계산 엔진 | 공제·규칙·조건·그룹 기반 계산 |
| 입력 관리 | 사용자 입력 필드 정의 및 세션 입력 |
| 계산 이력 | 계산 결과 및 규칙 적용 이력 |
| 콘텐츠 | 도움말·FAQ·Q&A |
| 사용자 | 회원·방문자·행동 로그 |

---

## 4. 계산 엔진 핵심 테이블

### 4.1 DED_MASTER (공제 마스터)

- 하나의 공제 단위를 정의한다.
- 화면 카드 박스와 1:1 매핑된다.

주요 설계 포인트:
- `CALC_TYPE_CD`로 계산 방식 분기
- `DISPLAY_ORDER`로 UI 순서 제어
- `DED_YN`으로 소득공제 / 세액공제 구분

---

### 4.2 CALC_TYPE (계산 방식 코드)

- 계산 로직 분기 기준 코드 테이블
- 예: SUM_ONLY, PERCENT_LIMIT, CARD_COMPLEX

> 계산 방식 추가는 코드 레벨에서만 허용

---

### 4.3 DED_RULE (공제 규칙)

- 하나의 공제는 여러 규칙을 가질 수 있다.

핵심 컬럼 규칙:

- `RULE_GROUP`
  - 순차 평가 단계 (1 → 2 → 3)
  - 낮은 그룹부터 평가

- `PRIORITY`
  - 같은 그룹 내 우선순위

- `FAIL_NEXT_GROUP_YN`
  - 실패 시 다음 그룹으로 이동 여부

---

### 4.4 DED_CONDITION (규칙 조건)

- 규칙을 만족하기 위한 IF 조건 단위

운영 원칙:
- 기본 논리는 AND
- OR 조건은 **규칙 분리로 처리 권장**
- OPERATOR_CD 확장은 코드 레벨에서 관리

---

### 4.5 DED_RULE_PARAM (규칙 파라미터)

- 계산에 필요한 숫자 요소 정의

설계 특징:
- PK: (RULE_ID, PARAM_NAME)
- APPLY_ORDER로 적용 순서 제어

주의 사항:
- APPLY_ORDER는 관리자 UI에서 필수 입력

---

### 4.6 CALC_GROUP / DED_GROUP_MAP

- 여러 공제의 한도를 공유하기 위한 구조

운영 원칙:
- 공제별 계산 완료 후 그룹 한도 적용
- GROUP_LIMIT NULL = 무제한

---

## 5. 입력 관리 구조

### 5.1 INPUT_FIELD_MASTER

- 사용자 입력 필드 정의
- 화면, 검증, 계산에서 공통 참조

---

### 5.2 USER_INPUT_CTX

- 계산 세션 단위 입력값 저장

운영 원칙:
- SESSION_ID 기준 휘발성 데이터
- 계산 완료 후 삭제 가능

---

## 6. 계산 이력 관리

### 6.1 CALC_HISTORY

- 최종 계산 결과 단위

컬럼 의미:
- FINAL_TAX: 산출 세액
- REFUND_AMOUNT: 환급 또는 추납 금액
- AMOUNT_TYPE: 환급 / 추납 구분

---

### 6.2 CALC_RESULT_DETAIL

- 공제별 적용 결과 및 규칙 추적
- 법적 분쟁 대응을 위한 핵심 테이블

---

## 7. 실제 계산 흐름 시뮬레이션

### 7.1 카드 소득공제 (복합 계산)

1. USER_INPUT_CTX 입력 적재
2. DED_MASTER → CALC_TYPE 확인
3. RULE_GROUP 순차 평가
4. 조건 만족 규칙 확정
5. 파라미터 적용
6. 그룹 한도 적용
7. 결과 이력 저장

---

### 7.2 중소기업 취업자 감면

- 조건 중심 규칙 평가
- RATE / LIMIT 기반 계산

---

### 7.3 의료비·교육비 그룹 한도

- 공제별 계산 후 합산
- GROUP_LIMIT 초과분 조정

---

## 8. 콘텐츠 / Q&A 설계 원칙

- HELP_CONTENT는 범용 콘텐츠 테이블
- REF_ID는 도메인별 참조 키로 사용
- 삭제 대신 ACTIVE_YN 사용

---

## 9. 로그 및 분석 설계

- VISITOR 기반 비회원 추적
- USER 연결 시 방문자 이력 승계
- SIMPLE_ANALYSIS_LOG는 개인정보 최소화 설계

---

## 10. 확장 및 유지보수 가이드

### 허용되는 변경
- 공제 추가
- 규칙/조건/파라미터 추가
- 그룹 구성 변경

### 금지되는 변경
- 기존 계산 의미 변경
- RULE_GROUP 의미 변경
- 이력 테이블 구조 변경

---

## 11. 결론

본 DB 설계는 다음을 만족한다.

- 실서비스 배포 가능 수준
- 법 개정 대응 가능
- 관리자 주도 운영 가능
- 계산 추적 및 감사 대응 가능

본 문서를 기준으로 **모든 개발과 운영은 일관되게 진행되어야 한다.**

(END)

